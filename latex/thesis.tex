\documentclass[12pt]{book}

\usepackage[top=1in, bottom=1in, left=1.5in, right=1.5in, letterpaper]{geometry}
\usepackage{booktabs}
\usepackage{setspace}
\usepackage{trackchanges}
\usepackage{fancyhdr}
\usepackage{etoolbox}
\usepackage{lipsum}
\usepackage{amsmath}
\usepackage{listings}
\usepackage{wasysym}
\usepackage{float}
\usepackage[font=small,labelfont=bf]{caption}
\usepackage[caption=false,font=footnotesize,format=hang]{subfig}
\usepackage{pgfplots}
\pgfplotsset{compat=newest}
\usepackage{pgfplotstable}
\usetikzlibrary{plotmarks,arrows}
\tikzset{>=latex}
%\usepgfplotslibrary{colorbrewer}
\usepackage[absolute,overlay]{textpos}
\usepackage{graphicx}
\usepackage{lmodern}
\usepackage{longtable}
\usepackage{xfrac}
\usepackage{siunitx}
\usepackage[style=ieee,backend=biber]{biblatex}
\addbibresource{references.bib}
\usepackage[hidelinks, bookmarks=true]{hyperref}
\usepackage{bookmark}
\usepackage{algorithmicx}
\usepackage{algpseudocode}
\usepackage[chapter]{algorithm}
%\usepackage{droid}
\usepackage[T1]{fontenc}
\usepackage[titletoc]{appendix}
\usepackage[section]{placeins}
\usepackage{xparse}
\usepackage{etoolbox}
\usepackage{ifthen}
\usepackage{multicol}

% add a "DRAFT" watermark to everything
%\usepackage{draftwatermark}
%\SetWatermarkLightness{0.8}
%\SetWatermarkScale{1.5}

% set up SIunitsX
\sisetup{
	group-four-digits = true,
	group-separator = {,},
	%per=frac,
	%fraction=nice
	%fraction=sfrac
	%per-mode=symbol,
	list-separator = {, },
	list-final-separator = {, },
}
%\newcommand{\usd}[1]{\SI{#1}[\$\ensuremath{\,}]{}}
\newcommand{\percent}{\%}

% set up colours for plots
% these are based on mapping colours that should photocopy in black and white well
\definecolor{pc1}{HTML}{8DD3C7}
\definecolor{pc2}{HTML}{FDB462}
\definecolor{pc3}{HTML}{FB8072}
\definecolor{pc4}{HTML}{80B1D3}
\definecolor{pc5}{HTML}{B3DE69}
\definecolor{pc6}{HTML}{BEBADA}
\definecolor{pc7}{HTML}{FCCDE5}
\definecolor{pc8}{HTML}{D9D9D9}
\definecolor{pc9}{HTML}{FFFFB3}
\pgfplotscreateplotcyclelist{ColourPlotCycle}{%
solid,ultra thick,pc1,every mark/.append style={fill=pc1},mark=*\\%
solid,ultra thick,pc2,every mark/.append style={fill=pc2},mark=square*\\%
solid,ultra thick,pc3,every mark/.append style={fill=pc3},mark=diamond*\\%
solid,ultra thick,pc4,every mark/.append style={fill=pc4},mark=pentagon*\\%
solid,ultra thick,pc5,every mark/.append style={fill=pc5},mark=triangle*\\%
dashed,ultra thick,pc6,every mark/.append style={fill=pc6},mark=*\\%
dashed,ultra thick,pc7,every mark/.append style={fill=pc7},mark=square*\\%
dashed,ultra thick,pc8,every mark/.append style={fill=pc8},mark=diamond*\\%
dashed,ultra thick,pc9,every mark/.append style={fill=pc9},mark=pentagon*\\%
}
\pgfplotscreateplotcyclelist{SmoothColourPlotCycle}{%
solid,ultra thick,pc1\\%
solid,ultra thick,pc2\\%
solid,ultra thick,pc3\\%
solid,ultra thick,pc4\\%
solid,ultra thick,pc5\\%
dashed,ultra thick,pc6\\%
dashed,ultra thick,pc7\\%
dashed,ultra thick,pc8\\%
dashed,ultra thick,pc9\\%
}
\pgfplotscreateplotcyclelist{BarColourPlotCycle}{%
fill=pc1\\%
fill=pc2\\%
fill=pc3\\%
fill=pc4\\%
fill=pc5\\%
fill=pc6\\%
fill=pc7\\%
fill=pc8\\%
fill=pc9\\%
}

\definecolor{RdBuWhiteGrey}{RGB}{247,247,247}
\pgfplotsset{
	colormap={RdBu}{
		rgb255(0cm)=(5,48,97);
		rgb255(1cm)=(33,102,172);
		rgb255(2cm)=(67,147,195);
		rgb255(3cm)=(146,197,222);
		rgb255(4cm)=(209,229,240);
		rgb255(5cm)=(247,247,247);
		rgb255(6cm)=(253,219,199);
		rgb255(7cm)=(244,165,130);
		rgb255(8cm)=(214,96,77);
		rgb255(9cm)=(178,24,43);
		rgb255(10cm)=(103,0,31);
	}
}
\pgfplotsset{
	colormap={YlOrRd}{
		rgb255(0cm)=(128,0,38);
		rgb255(1cm)=(189,0,38);
		rgb255(2cm)=(227,26,28);
		rgb255(3cm)=(252,78,42);
		rgb255(4cm)=(253,141,60);
		rgb255(5cm)=(254,178,76);
		rgb255(6cm)=(254,217,118);
		rgb255(7cm)=(255,237,160);
		rgb255(8cm)=(255,255,204);
	}
}

% set up colours for schematics
\definecolor{tissueColour}{RGB}{251,185,130}
\definecolor{lesionColour}{RGB}{175,50,53}
\definecolor{fatColour}{RGB}{240,236,182}
\definecolor{boneColour}{RGB}{200,200,200}

% set up source code listing
\definecolor{mygreen}{rgb}{0,0.6,0}
\definecolor{mygray}{rgb}{0.5,0.5,0.5}
\definecolor{mymauve}{rgb}{0.58,0,0.82}

\lstset{ %
	backgroundcolor=\color{white},     % choose the background color; you must add \usepackage{color} or \usepackage{xcolor}
	basicstyle=\footnotesize\ttfamily, % the size of the fonts that are used for the code
	breakatwhitespace=false,           % sets if automatic breaks should only happen at whitespace
	breaklines=true,                   % sets automatic line breaking
	captionpos=t,                      % sets the caption-position to bottom
	commentstyle=\color{mygreen},      % comment style
	deletekeywords={...},              % if you want to delete keywords from the given language
	escapeinside={\%*}{*)},            % if you want to add LaTeX within your code
	extendedchars=true,                % lets you use non-ASCII characters; for 8-bits encodings only, does not work with UTF-8
	frame=L,                           % adds a frame around the code
	keepspaces=true,                   % keeps spaces in text, useful for keeping indentation of code (possibly needs columns=flexible)
	keywordstyle=\color{blue},         % keyword style
	morekeywords={*,...},              % if you want to add more keywords to the set
	numbers=left,                      % where to put the line-numbers; possible values are (none, left, right)
	numbersep=10pt,                     % how far the line-numbers are from the code
	numberstyle=\tiny\color{mygray},   % the style that is used for the line-numbers
	rulecolor=\color{black},           % if not set, the frame-color may be changed on line-breaks within not-black text (e.g. comments (green here))
	showspaces=false,                  % show spaces everywhere adding particular underscores; it overrides 'showstringspaces'
	showstringspaces=false,            % underline spaces within strings only
	showtabs=false,                    % show tabs within strings adding particular underscores
	stepnumber=2,                      % the step between two line-numbers. If it's 1, each line will be numbered
	stringstyle=\color{mymauve},       % string literal style
	tabsize=2,                         % sets default tabsize to 2 spaces
	title=\lstname                     % show the filename of files included with \lstinputlisting; also try caption instead of title
}

% array access for parameters
\newcounter{paramListTotal}\newcounter{paramListCtr}%
\NewDocumentCommand{\paramVal}{o}{%
  \setcounter{paramListTotal}{0}\setcounter{paramListCtr}{-1}%
  \renewcommand*{\do}[1]{\stepcounter{paramListTotal}}%
  \expandafter\docsvlist\expandafter{\paramVals}%
  \IfNoValueTF{#1}
    {\paramVals}% \paramVal
    {% \paramVal[<index>]
     \renewcommand*{\do}[1]{\stepcounter{paramListCtr}\ifnum\value{paramListCtr}=#1\relax##1\fi}%
     \expandafter\docsvlist\expandafter{\paramVals}}%
}

% for showing a graph's data in the graph
\newcommand{\fourLegendMarksA}{\raisebox{2pt}{\tikz{\draw[pc1,solid,ultra thick](0,0) -- (5mm,0); \draw[mark=*,mark size=3pt,mark options={color=pc1}] plot coordinates {(2.5mm,0)};}}}
\newcommand{\fourLegendMarksB}{\raisebox{2pt}{\tikz{\draw[pc2,solid,ultra thick](0,0) -- (5mm,0); \draw[mark=square*,mark size=3pt,mark options={color=pc2}] plot coordinates {(2.5mm,0)};}}}
\newcommand{\fourLegendMarksC}{\raisebox{2pt}{\tikz{\draw[pc3,solid,ultra thick](0,0) -- (5mm,0); \draw[mark=diamond*,mark size=3pt,mark options={color=pc3}] plot coordinates {(2.5mm,0)};}}}
\newcommand{\fourLegendMarksD}{\raisebox{2pt}{\tikz{\draw[pc4,solid,ultra thick](0,0) -- (5mm,0); \draw[mark=pentagon*,mark size=3pt,mark options={color=pc4}] plot coordinates {(2.5mm,0)};}}}
\newcommand{\characterizationDataTable}[9]{
	%\def\paramVals{\fourLegendMarksA,\fourLegendMarksB,\fourLegendMarksC,\fourLegendMarksD}
	\def\paramVals{#3}
	\pgfplotstabletranspose[columns={#5}, string type]{\renderedTable}{#6}
	\ifthenelse{\equal{#7}{}}{}{\pgfplotstabletranspose[columns={#5}, string type]{\transB}{#7}\pgfplotstablevertcat{\renderedTable}{\transB}}
	\ifthenelse{\equal{#8}{}}{}{\pgfplotstabletranspose[columns={#5}, string type]{\transC}{#8}\pgfplotstablevertcat{\renderedTable}{\transC}}
	\ifthenelse{\equal{#9}{}}{}{\pgfplotstabletranspose[columns={#5}, string type]{\transD}{#9}\pgfplotstablevertcat{\renderedTable}{\transD}}
	\pgfplotstablecreatecol[
		create col/assign/.code={%
			\edef\entry{\paramVal[\pgfplotstablerow]}%
			\pgfkeyslet{/pgfplots/table/create col/next content}\entry
	}]
	{param}\renderedTable
	\begin{table}[H]
		\centering
		\caption[]{Data for Fig. \protect\ref{#4}}
		\pgfplotstabletypeset[
			columns={param,0,1,2,3},
			columns/param/.style={
				string type,
				column name={(#2)},
				column type=c
			},
			columns/0/.style={
				numeric type,
				column name={{0.32}},
				fixed,fixed zerofill,precision=2
			},
			columns/1/.style={
				numeric type,
				column name={0.56},
				fixed,fixed zerofill,precision=2
			},
			columns/2/.style={
				numeric type,
				column name={1.80},
				fixed,fixed zerofill,precision=2
			},
			columns/3/.style={
				numeric type,
				column name={3.20},
				fixed,fixed zerofill,precision=2
			},
			every head row/.style={
				before row={%
					\toprule
					#1 & \multicolumn{4}{c}{\ensuremath{E_{nom}}} \\
					\cmidrule{2-5}
				},
				after row=\midrule
			},
			every last row/.style={after row=\bottomrule}
		]\renderedTable
	\end{table}
}

% align subfloats to the top of the float
%\captionsetup[subfloat]{position=top}

% highlight footnotes in red
\renewcommand\thefootnote{\textcolor{red}{\arabic{footnote}}}
% TODO: automate footnote command with \textcolor{red} in the footnote as well

% setup the bibliography
%\renewcommand\bibname{References}
\DefineBibliographyStrings{english}{%
	bibliography = {References}
}

% strip URLs from the references
\DeclareSourcemap{
  \maps{
    \map{
      \step[fieldsource=url,
            match=\regexp{.*},
            fieldset=url, null]
    }
  }
}

% remove empty pages after \chapter commands
\let\cleardoublepage\clearpage

% set up our headers
\setlength{\headheight}{15.2pt}
\pagestyle{fancy}
\fancyhf{}
\renewcommand{\headrulewidth}{0pt}

\makeatletter
\renewcommand\chapter{\if@openright\cleardoublepage\else\clearpage\fi
                    \thispagestyle{fancyplain}% original style: plain
                    \global\@topnum\z@
                    \@afterindentfalse
                    \secdef\@chapter\@schapter}
\makeatother

% some utility commands
\newcommand{\comment}[1]{}
\newcommand{\x}[1]{}
\newcommand{\bibcomplete}[1]{}

% trackchanges editors
\addeditor{KH}
\addeditor{MFP}
\addeditor{WM}

% rename "Figure" to "Fig."
\def\figurename{Fig.}

% rename "Contents" to "Table of Contents"
\renewcommand*\contentsname{Table of Contents}

\begin{document}

\pdfbookmark{Title Page}{title}
\input{frontback/titlepage}
\newpage

\setcounter{page}{1}
\pagenumbering{roman}
\doublespacing
\rfoot[\thepage]{\thepage}

\pdfbookmark{Abstract}{abstract}
\input{frontback/abstract}
\newpage
\pdfbookmark{Preface}{preface}
\input{frontback/preface}
\newpage
\pdfbookmark{Dedication}{dedication}
\input{frontback/dedication}
\newpage
\pdfbookmark{Acknowledgements}{acknowledgements}
\input{frontback/acknowledgements}
\newpage
\input{frontback/toc}
\newpage
\pdfbookmark{Nomenclature}{nomenclature}
\input{frontback/nomenclature}
\newpage

\setcounter{page}{1}
\pagenumbering{arabic}
\doublespacing
\rfoot[\thepage]{\thepage}

\input{chapters/introduction}
\input{chapters/litreview}
\input{chapters/quasi-static}
\input{chapters/arfi}
\input{chapters/shear}
\input{chapters/conclusion}

%% BIBLIOGRAPHY %%
\cleardoublepage

\phantomsection

\addcontentsline{toc}{chapter}{References}
\printbibliography

%% APPENDICES %%
\appendix

\begin{appendices}
\input{appendices/datatables}
\input{appendices/sourcecode}
\end{appendices}

\end{document}